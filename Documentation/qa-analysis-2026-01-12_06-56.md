# QA Analysis Report

## Executive summary
- Reviewed recent commits: `b2dc63f` (OpenSpec specs added), `99a13ea` (sidebar UI move), `09d14c6` (web search/summarization/title additions).
- Main runtime impact is in the Open Canvas LangGraph flow: new web search routing, summarization, and session title generation, plus internal message handling.
- RAG pipeline logic is unchanged in these commits; retrieval still uses the last user message from `state.messages`.
- Artifact persistence behavior is unchanged; session title persistence is newly exercised via graph output and viewmodel sync.

## Impacted subsystems

### LangGraph flows
- `core/graphs/open_canvas/graph.py`: new nodes `webSearch`, `routePostWebSearch`, `summarizer`, and `generateTitle`; `cleanState` now conditionally routes to title generation or summarization; `generatePath` short-circuits to web search when enabled.
- `core/graphs/open_canvas/state.py`: added `internal_messages` with a summary-aware reducer and `session_title` output; added web search fields in state.
- `core/graphs/open_canvas/prompts.py`: added web search classifier/query prompts, summarizer prompt/template, and title prompts.
- `core/utils/messages.py`: added message formatting for prompt injection and a hidden AI message builder for web search results.

### RAG pipelines
- `core/graphs/rag/graph.py` and `core/graphs/rag/nodes.py` are unchanged in the recent commits.
- RAG retrieval still derives the query from `state.messages`; web search summaries and `internal_messages` do not influence retrieval.

### Artifact lifecycle and persistence
- `ui/viewmodels/chat_viewmodel.py`: now passes `internal_messages` and web search config into graph state/config; consumes `session_title` from graph output and updates the session record.
- Artifact storage and versioning paths remain unchanged; no new persistence paths for artifacts were introduced.

## Risk assessment
- **Medium**: Web search results are injected only into `internal_messages` and are not persisted with chat history, which can make results non-reproducible or harder to audit.
- **Medium**: Summarization replaces `internal_messages` after the character threshold; downstream generations rely on summaries that may diverge from the full UI-visible history.
- **Low**: Web search classification or query generation failures fall back to empty results; flow continues without external context.
- **Low**: Title generation relies on tool-call output; missing tool calls leave titles as the initial user-derived fallback.

## Recommendations
- Run existing graph/viewmodel tests and a quick manual pass covering: web search on/off, summarizer trigger, and session title updates.
- Validate that hidden web search messages remain internal-only and are not persisted or surfaced in the UI.
- Confirm Exa/OpenRouter credentials and throttling behavior under web-search-enabled flows to avoid silent no-result paths.
