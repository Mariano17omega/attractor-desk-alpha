# QA Bug Report - 2026-01-14 03:04

## Bugs

[X] 1) Web search flow forces artifact paths (missing reply/theme routes)
- File/Location: `core/graphs/open_canvas/graph.py:341-437`
- Severity: Major
- Description: When `web_search_enabled` is true, `generatePath` always routes to `webSearch`, and `route_post_web_search` always sets `next` to `generateArtifact` or `rewriteArtifact`. This skips `replyToGeneralInput` and theme/update routes even when the user asked a general question or a theme change. With Deep Search enabled, most non-artifact queries get incorrectly treated as artifact generation.
- Suggested fix: Preserve the original routing intent (e.g., store a `post_web_search_next` from `_dynamic_determine_path` or rerun routing after web search with `web_search_enabled` disabled), and add `replyToGeneralInput` and theme/update branches to `routePostWebSearch`.

[ ] 2) Dead graph nodes: `generateFollowup` and `reflect`
- File/Location: `core/graphs/open_canvas/graph.py:371-445`
- Severity: Minor
- Description: Nodes `generateFollowup` and `reflect` are registered and have edges between them, but there are no inbound edges from any active path. This makes them unreachable (dead states), which can confuse maintenance and hides missing transitions for expected follow-up behavior.
- Suggested fix: Either wire artifact-generation paths through `generateFollowup` -> `reflect`.

[ ] 3) RAG query extraction breaks on multi-part message content
- File/Location: `core/graphs/rag/nodes.py:16-25, 95-99`
- Severity: Major
- Description: `_last_user_message` returns `str(message.content)` for non-string content. When the user attaches images, message content is a list of dicts, so the query becomes a JSON-like string with `image_url` metadata instead of just the user text. This degrades retrieval and can cause irrelevant or empty results.
- Suggested fix: Extract only textual parts (similar to `get_string_from_content` in `core/utils/messages.py`) and ignore non-text parts when building the RAG query.

[ ] 4) Stale worker results can be applied to a new session or after cancellation
- File/Location: `ui/viewmodels/chat_viewmodel.py:201-319, 314-340, 417-424`
- Severity: Major
- Description: `cancel_generation` only flips `_cancelled` and does not stop the running `GraphWorker`. Starting a new message resets `_cancelled` to `False`. If the old worker finishes later, `_on_graph_finished` will apply its results to the current session and persist them, even if the user canceled or switched sessions mid-run.
- Suggested fix: Track a per-worker token (or session id) and ignore results that do not match the active run/session. Alternatively, disable starting a new run until the previous worker finishes or support a cooperative cancellation flag passed into the graph execution.

[ ] 5) Highlighted text update may edit the wrong occurrence
- File/Location: `core/graphs/open_canvas/nodes/update_highlighted_text.py:47-58`
- Severity: Minor
- Description: The update uses `full_markdown.find(selected_text)` and replaces the first match. If the selected text appears multiple times, the wrong section can be updated, producing incorrect artifact edits.
- Suggested fix: Use selection offsets or `markdown_block` from `TextHighlight` to locate the correct occurrence, or pass precise start/end indices from the UI and slice by index instead of `find()`.
